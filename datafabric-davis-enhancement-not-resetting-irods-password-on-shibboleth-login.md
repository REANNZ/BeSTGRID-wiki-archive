# DataFabric Davis enhancement - not resetting iRODS password on Shibboleth login

Davis, the web (and webDAV) front-end to iRODS, used in the BeSTGRID DataFabric, offers logging in either via Shibboleth or with a username and password (only username+password login can be used for webDAV).  The username and password entered can be checked either against a MyProxy server (yielding an X509 certificate to use for accessing iRODS on behalf of the user) or with an iRODS username and password directly.

In the original design of Davis, the Shibboleth login was implemented in a way where:

1. Davis would be only accessed via a Shibboleth-protected URL
2. Davis would receive the sharedToken and commonName attributes from the Shibboleth session
3. Davis would establish a session with the iRODS server as the **rods** admin user (using GSI authentication with the host certificate)
4. Davis would use this session to invoke the server-side **createUser** command that would:
	
1. Create a user account if it does not exist yet (optional)
2. Reset the internal iRODS password for the user account to the one passed to the createUser command (and generated by Davis on the fly)
5. Davis would then establish a username+password based iRODS session with the user account located by the sharedToken and the password passed to the createUser command.

The downside of this approach is that in step 4.b, it resets the iRODS password for a user account on every Shibboleth login - making it impossible to use the DataFabric with clients that would be talking to the iRODS server directly and would use a username and password - [iDrop](https://code.renci.org/gf/project/irodsidrop/) is one such client.

This page documents an enhancement to Davis and the DataFabric that:

- Changes the Davis Shibboleth login so that it does not need to reset the iRODS user account passwords.
- Provides a way for users to set an iRODS password based on a Shibboleth login.
- Provides a way for users to change their iRODS password based on an existing iRODS username+password login (suitable for users who cannot use a Shibboleth login but have already been provided with an iRODS password - that they need to change).

# Davis Shibboleth Login changes

To overcome the need to reset the user password, the modifications introduced here instead use the iRODS protocol support for an admin user acting on behalf of another user - the equivalent of setting the `clientUserName` environment variable with i-Commands.

This feature is supported by the iRODS protocol, but not by the Jargon library.  The support has been added as a part of this enhancement and is pending commit to the main Jargon-classic repository (expected in the week of October 15th, 2012).

The Shibboleth login keeps the first three steps from the original workflow, but once Davis has the session as an administrator, it changes to:

- Davis uses the administrator session to query the iRODS database for the username (based on the sharedToken value)
- **If the account is not found, it is created by invoking the*createUser** command and the search is repeated.
- Davis establishes a session with admin credentials used for authentication, but uses the username to act on behalf of the user.

As using a different client username does not work with GSI, Davis has to a username+password based login for the **rods** admin account.

## Configuration options added

To support this new funcionality, this extension adds the following options to the Davis configuration file:

**admin-creds-dir**: Set location of admin credentials.  When set, should point to a directory that has the login details for a rodsadmin account (typically the rods user).  The directory should contain two files:

- .irodsEnv at least setting irodsUserName - e.g.:

``` 
irodsUserName 'rods'
```
- .irodsA with a single line containing the password of the rods user
- Default is no directory is set: 

``` 
# admin-creds-dir=
```

**shib-use-admin-login**: Enable this alternative login method for Shibboleth login that does not reset the password associated with the iRODS account but instead uses an admin account to establish the connection - but the connection runs with the privileges of the target user. 

- This option requires that the admin-creds-dir option is correctly configured to log in as a rodsadmin account (typically rods).
- Default is false: 

``` 
shib-use-admin-login=false
```

## Implementation details

- Jargon is modified to extend the edu.sdsc.grid.io.irods.IRODSAccount API with support for setting a clientUserName
- webdavis.AuthorizationProcessor is modified to use the clientUserName login method when shib-use-admin-login is set to true
- webdavis.ShibUtil is modified:
	
- the code looking up an account by sharedToken is factored out into the `lookupUsernameByST` method
- the createUser command is only invoked if the user account is not found
- webdavis.DavisConfig is modified to parse the two new configuration options

## Code access

The code has been committed to a feature-branch in the googlecode webDavis repository: [http://webdavis.googlecode.com/svn/davis/branches/0.9.6.dev-shib-no-pwd-reset](http://webdavis.googlecode.com/svn/davis/branches/0.9.6.dev-shib-no-pwd-reset)

The code is also available as patch: [davis-clientusername-login.diff](/wiki/download/attachments/3818228914/Davis-clientusername-login.diff.txt?version=1&modificationDate=1539354381000&cacheVersion=1&api=v2)

This patch depends on modifications to Jargon - these are pending to be committed to Jargon-classic svn an and are available as patch [jargon-add-clientusername.diff](/wiki/download/attachments/3818228914/Jargon-add-clientusername.diff.txt?version=1&modificationDate=1539354381000&cacheVersion=1&api=v2)

### Building jargon with this patch

- Checkout jargon source code:

``` 
svn co svn://irodssvn.ucsd.edu/trunk irods-trunk
```
- Apply patch and build jargon

``` 

 cd irods-trunk/iRODS/jargon
 patch -p2 < ../../../jargon-add-clientusername.diff
 ant

```
- Produces `target/dist/Jargon.jar`

### Building Davis with this patch

- Checkout webDavis source code:

``` 
svn co https://webdavis.googlecode.com/svn/davis/branches/0.9.6.dev-shib-no-pwd-reset davis-branch
```
- Note: as of rev 955, this branch already has a Jargon build with the required patches applied - as `WebContent/WEB-INF/lib/jargon-trunk-5264-w-clientusername.jar`
- Build Davis:


>  cd davis-branch
>  ant
>  cd davis-branch
>  ant

- Produces `dist/davis-0.9.6.dev.tar.gz`

# Setting a user password

Part of this extension is a simple PHP page that based on Shibboleth authentication allows a user to set their iRODS password.

- This page is typically at: /dfpassword/
- This page needs `rods` admin access to set the user password.
- Source code for the page is available at [https://subversion.ceres.auckland.ac.nz/BeSTGRID/df/usermgmt/dfpassword/](https://subversion.ceres.auckland.ac.nz/BeSTGRID/df/usermgmt/dfpassword/)
- Installation instructions will be covered in the [Slave server install manual](installing-an-irods-slave-server.md)

# Changing a user passsword

Part of this extension is also a simple PHP page that allows changing password based on an existing iRODS login (suitable for people without a Shibboleth login). 

- This page is typically at: /dfchangepw/
- This page acts as if the user executed an `ipasswd` command.  The page does not need any privileged access.
- Source code for the page is available at [https://subversion.ceres.auckland.ac.nz/BeSTGRID/df/usermgmt/dfchangepw/](https://subversion.ceres.auckland.ac.nz/BeSTGRID/df/usermgmt/dfchangepw/)
- Installation instructions will be covered in the [Slave server install manual](installing-an-irods-slave-server.md)
